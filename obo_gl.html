<!doctype html>
<html> <!-- tut @ http://learningwebgl.com/blog/?p=28 -->
	<head>
		<title>WebGL demo</title>
		<!-- https://cvs.khronos.org/svn/repos/registry/trunk/public/webgl/sdk/demos/common/webgl-utils.js -->
		<script src="js/webgl-utils.js" type="text/javascript"></script>
		<!-- https://github.com/toji/gl-matrix -->
		<script src="js/gl-matrix-min.js" type="text/javascript"></script>
		<script src="js/render.js" type="text/javascript"></script>
		<script src="js/gamelogic.js" type="text/javascript"></script>
		<script src="js/ball.js" type="text/javascript"></script>
		<script src="js/pill.js" type="text/javascript"></script>
		<script src="js/cube.js" type="text/javascript"></script> <!-- for testing reasons only -->
		<script id="shader-fs" type="x-shader/x-fragment">
			varying highp vec3 color;
			varying highp vec3 lighting;
			
			void main(void)
			{
				gl_FragColor = vec4(color * lighting, 1.0);
			}
		</script>
		<script id="shader-vs" type="x-shader/x-vertex">
			highp vec3 ambientLight          = vec3(0.60, 0.60, 0.60);
			highp vec3 directionalLightColor = vec3(0.50, 0.50, 0.75);
			highp vec3 directionalVector     = vec3(0.85, 0.80, 0.75);
			
			attribute highp vec3 vertexNormal;
			attribute highp vec3 vertexPosition;
			
			uniform highp vec3 meshColor; // every vertex of the same object has the same color
			uniform highp mat4 nMatrix;
			uniform highp mat4 mvMatrix;
			uniform highp mat4 projMatrix;
			
			varying highp vec3 color;
			varying highp vec3 lighting;

			void main(void)
			{
				highp vec4 transformedNormal = nMatrix * vec4(vertexNormal, 1.0);
				highp float directional      = max(dot(transformedNormal.xyz, directionalVector), 0.0);
				
				color       = meshColor;
				lighting    = ambientLight + (directionalLightColor * directional);
				
				gl_Position = projMatrix * mvMatrix * vec4(vertexPosition, 1.0);
			}
		</script>
		<script type="text/javascript">			
			var Controls = {
				moveLeft:      false,
				moveRight:     false,
				moveDownwards: false,
				moveTowards:   false
			};
			
			window.onkeydown = function(event)
			{
				switch (event.keyCode)
				{
					case 37: Controls.moveLeft      || (Controls.moveLeft = true);      break; // left
					case 39: Controls.moveRight     || (Controls.moveRight = true);     break; // right
					case 38: Controls.moveDownwards || (Controls.moveDownwards = true); break; // up
					case 40: Controls.moveTowards   || (Controls.moveTowards = true);   break; // down
					default: console.log(event.keyCode);
				}
			}
			
			window.onkeyup = function(event)
			{
				switch (event.keyCode)
				{
					case 37: !Controls.moveLeft      || (Controls.moveLeft = false);      break; // left
					case 39: !Controls.moveRight     || (Controls.moveRight = false);     break; // right
					case 38: !Controls.moveDownwards || (Controls.moveDownwards = false); break; // up
					case 40: !Controls.moveTowards   || (Controls.moveTowards = false);   break; // down
					default: console.log("Key pressed: " + event.keyCode);
				}
			}
			
			function animate()
			{
				if (Controls.moveLeft)
					player.x -= 0.5;
				if (Controls.moveRight)
					player.x += 0.5;
				if (Controls.moveDownwards)
					player.z -= 0.5;
				if (Controls.moveTowards)
					player.z += 0.5;
					
				// spin player paddle along x axis
				if (player.rot_x >= MAX_DEG)
					player.rot_x = 0.1;
				else
					player.rot_x += 0.1;
				
				// move game ball up- and downwards
				if (gameBall.y > 14.0 || gameBall.y < -12.0)
					gameBall.speedY  = -gameBall.speedY;				
				gameBall.y += gameBall.speedY;
			}
			
			window.onload = function()
			{
				var canvas = document.getElementById("rc");
				
				initGL(canvas);
				initShaders();
				initBuffers(Pill);
				initBuffers(Ball);
				initBuffers(Cube);
				initEnvironment();	// create needed matrices for opengl and set perspective
				
				//for (object in gl)
				//	console.log(object);
				
				createGame();		// create all game instances (player, ball, ...)
				
				window.setInterval(animate, 30); // do animation in 30 ms interval
				
				// IMPORTANT: this function is NO blocking call
				// the render loop will be started in a new thread
				startMainLoop(); 
			};
		</script>
		<style type="text/css">
			body {
				text-align: center;
			}
			
			canvas#rc {
				position: relative;
				width: 800;
				height: 600;
				margin: 10px auto;
				text-align: left;
				box-shadow: 5px 5px 5px #888;
			}
		</style>
	</head>
	<body>
		<div id="fps"></div>
		<canvas width="800" height="600" id="rc">
			Your browser does not support the canvas element.
		</canvas>
	</body>
</html>
